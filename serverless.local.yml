# ClaimIQ Serverless Local Development Configuration
# This overrides the main serverless.yml for local development

service: claimiq-ingestion

frameworkVersion: '3'

# YAML Anchors for reusability
x-common-cors: &common-cors
  origin: '*'
  headers:
    - Content-Type
    - X-Amz-Date
    - Authorization
    - X-Api-Key
    - X-Amz-Security-Token
    - X-Tenant-Id
    - X-Hospital-Id
  allowCredentials: false

x-upload-cors: &upload-cors
  origin: '*'
  headers:
    - Content-Type
    - X-Amz-Date
    - Authorization
    - X-Api-Key
    - X-Amz-Security-Token
  allowCredentials: false

x-lambda-defaults: &lambda-defaults
  runtime: nodejs18.x
  memorySize: 1024
  timeout: 300

provider:
  name: aws
  runtime: nodejs18.x
  region: ${env:AWS_REGION, 'us-east-1'}
  stage: local
  memorySize: 1024
  timeout: 300
  
  # Environment variables from env-local.json
  environment:
    ENVIRONMENT: local
    CLAIMS_BUCKET_NAME: ${file(env-local.json):CLAIMS_BUCKET_NAME}
    AURORA_CLUSTER_ARN: ${file(env-local.json):AURORA_CLUSTER_ARN}
    AURORA_SECRET_ARN: ${file(env-local.json):AURORA_SECRET_ARN}
    AGENT_LOGS_TABLE: ${file(env-local.json):AGENT_LOGS_TABLE}
    DATABASE_NAME: ${file(env-local.json):DATABASE_NAME}
    MAX_FILE_SIZE_MB: ${file(env-local.json):MAX_FILE_SIZE_MB}
    IS_OFFLINE: true
  
  # For local development, we don't need VPC or IAM role restrictions
  # The functions will use your local AWS credentials

# Package configuration
package:
  patterns:
    - '!.git/**'
    - '!.gitignore'
    - '!README.md'
    - '!terraform/**'
    - '!.serverless/**'
    - '!*.zip'
    - '!**/*.test.ts'
  individually: true

functions:
  # Lambda Authorizer Function (JWT validation)
  authorizer:
    <<: *lambda-defaults
    handler: src/lambda/authorizer/index.handler
    name: local-claimiq-authorizer
    description: 'ClaimIQ JWT authorizer for API Gateway authentication (Local)'
    memorySize: 512
    timeout: 30
    environment:
      FUNCTION_NAME: authorizer
      USER_POOL_ID: ${file(env-local.json):USER_POOL_ID}
      USER_POOL_CLIENT_ID: ${file(env-local.json):USER_POOL_CLIENT_ID}

  # File Upload Function (Pre-signed URL generation)
  fileUpload:
    <<: *lambda-defaults
    handler: src/lambda/file_upload/index.handler
    name: local-claimiq-file-upload
    description: 'ClaimIQ pre-signed URL generator for direct S3 uploads (Local)'
    environment:
      FUNCTION_NAME: file-upload
    events:
      - http:
          path: upload
          method: post
          cors: *common-cors
      - http:
          path: upload/{claimId}
          method: get
          cors: *upload-cors

  # S3 Event Processor Function (Triggered by S3 uploads)
  s3Processor:
    <<: *lambda-defaults
    handler: src/lambda/s3_processor/index.handler
    name: local-claimiq-s3-processor
    description: 'ClaimIQ S3 event processor - triggers workflow on file upload (Local)'
    environment:
      FUNCTION_NAME: s3-processor
      STEP_FUNCTION_ARN: ${file(env-local.json):STEP_FUNCTION_ARN, ''}

  # Health Check Function (No authorization needed)
  healthCheck:
    <<: *lambda-defaults
    handler: src/lambda/file_upload/index.healthHandler
    name: local-claimiq-health
    description: 'ClaimIQ API health check endpoint (Local)'
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: health-check
    events:
      - http:
          path: health
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
            allowCredentials: false

  # Data Normalization Function (Python)
  normalization:
    handler: src/lambda/normalization/lambda_function.lambda_handler
    name: local-claimiq-normalization
    description: 'ClaimIQ data normalization handler (Local)'
    runtime: python3.11
    memorySize: 2048
    timeout: 600
    environment:
      FUNCTION_NAME: normalization

  # Database Update Function
  dbUpdate:
    <<: *lambda-defaults
    handler: src/lambda/db_update/index.handler
    name: local-claimiq-db-update
    description: 'ClaimIQ database update handler for Step Functions (Local)'
    memorySize: 512
    timeout: 30
    environment:
      FUNCTION_NAME: db-update
      DATABASE_NAME: ${file(env-local.json):DATABASE_NAME}

# Plugins
plugins:
  - serverless-plugin-typescript
  - serverless-python-requirements
  - serverless-offline

# Custom configuration
custom:
  # TypeScript plugin configuration
  serverless-plugin-typescript:
    tsConfigFileLocation: './tsconfig.json'
  
  # Python requirements plugin configuration
  pythonRequirements:
    dockerizePip: non-linux
    slim: true
    strip: false
    noDeps:
      - boto3
      - botocore
    pipCmdExtraArgs:
      - --no-cache-dir
  
  # Serverless Offline configuration
  serverless-offline:
    httpPort: 3000
    lambdaPort: 3002
    websocketPort: 3001
    noPrependStageInUrl: true
    noAuth: false
    printOutput: true
    useChildProcesses: true
    # Skip authorization for local development (optional)
    # noAuth: true